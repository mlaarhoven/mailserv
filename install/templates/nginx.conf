user www;

pid        /var/run/nginx.pid;
error_log  /var/log/httpd.err error;

worker_processes auto;
events {
    worker_connections  128;
}

http {
    include         mime.types;
    default_type    application/octet-stream;
    access_log      /var/log/httpd.log;

    # Not in OpenBSD? sendfile       on;
    # Not in OpenBSD? tcp_nopush     on;
    # use default 75s? keepalive_timeout  5;
    # off is default. server_name_in_redirect off;

    # no nginx version number in response
    server_tokens off;

    client_max_body_size    16M;
    client_body_buffer_size 512k;

    gzip            on;
    gzip_min_length 1000;
    gzip_proxied    no-cache no-store private expired auth;
    gzip_types      application/javascript application/json application/xml text/css text/plain text/xml ;

    #https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    #ssl_ciphers ECDH+AESGCM:ECDH+CHACHA20:ECDH+AES256:ECDH+AES128:!aNULL:!SHA1:!AESCCM;
    #ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256;
    # join in ssl_ciphers
    ssl_ciphers TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:ECDH+AESGCM:ECDH+CHACHA20:ECDH+AES256:ECDH+AES128:!aNULL:!SHA1:!AESCCM;

    ssl_certificate      /etc/ssl/server.crt;
    ssl_certificate_key  /etc/ssl/private/server.key;

    # 1MB of shared SSL cache
    ssl_session_cache shared:SSL:1m;
    # default: ssl_session_timeout 5m;

    # upstream admin_mongrels {
    #    server 127.0.0.1:4213;
    # }
    # upstream account_mongrels {
    #     server 127.0.0.1:4214;
    # }

    # ADMIN SERVER
    # server {
    #     listen 4200 ssl
    #     root   /var/mailserv/admin/public;

    #     location ~* \.(ico|css|js|gif|jpe?g|png) {
    #         access_log off;
    #         expires 7d;
    #         break;
    #     }

    #     location / {
    #         proxy_redirect   off;
    #         proxy_set_header Host              $host:4200;
    #         proxy_set_header X-Real-IP         $remote_addr;
    #         proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    #         proxy_set_header X_Forwarded_Proto $scheme;

    #         if (!-f $request_filename.html) {
    #             proxy_pass  http://admin_mongrels;
    #         }
    #     }
    # }

    # Only HTTPS
    server {
        listen 80 default_server;
        server_name _;
        location / {
            return 301 https://$hostname$request_uri;
        }

        #letsencrypt
        location /.well-known/acme-challenge/ {
            alias       /var/www/acme/;
            try_files   $uri =404;
        }
    }
  
    # HTTPS
    server {
        listen  443 ssl http2;
        root    /var/www/roundcubemail/public_html;
        index   index.php index.html index.htm;

        # See https://nealpoole.com/blog/2011/04/setting-up-php-fastcgi-and-nginx-dont-trust-the-tutorials-check-your-configuration/
        # Also stopped bij PHP security.limit_extensions
        # pass the PHP scripts to FastCGI server listening on unix socket
        location ~ \.php$ {
            try_files       $uri =404;
            include         fastcgi_params;
            fastcgi_param   SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_pass    unix:/run/php-fpm.sock;
        }

        location ~* \.(ico|css|js|gif|jpe?g|png) {
            access_log off;
            expires 7d;
            break;
        }

        #ACCOUNT PAGES
        # location ^~ /account/stylesheets {
        #     alias /var/mailserv/account/public/stylesheets;
        # }

        # location ^~ /account/javascripts {
        #     alias /var/mailserv/account/public/javascripts;
        # }

        # location ^~ /account/images {
        #     alias /var/mailserv/account/public/images;
        # }

        # location /account {
        #     proxy_redirect    off;
        #     proxy_set_header  Host             $host;
        #     proxy_set_header  X-Real-IP        $remote_addr;
        #     proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;
        #     proxy_set_header  Port             $proxy_port;

        #     if (!-f $request_filename.html) {
        #         proxy_pass  http://account_mongrels;
        #     }
        # }

    }

}
